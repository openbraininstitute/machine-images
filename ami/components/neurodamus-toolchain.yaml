---
name: neurodamus-toolchain
description: Install toolchain for neurodamus
schemaVersion: 1.0
phases:
  - name: build
    steps:
      - name: EFA-and-OpenMPI
        action: ExecuteBash
        inputs:
          commands:
            - |-
              #!/bin/bash
              set -euo pipefail
              set -x
              echo "Start openbraininstitute step: EFA-and-OpenMPI"
              dnf -y install bison cpp cmake gcc-c++ flex git libfl-devel python3.11-devel python3-pip python-devel python3-virtualenv readline-devel ninja-build
              cd /tmp
              curl -O https://efa-installer.amazonaws.com/aws-efa-installer-latest.tar.gz
              tar xf aws-efa-installer-latest.tar.gz
              cd aws-efa-installer
              ./efa_installer.sh -y --skip-kmod --mpi=openmpi5
              cd -
              rm -rf /tmp/aws*
              echo "End openbraininstitute step: EFA-and-OpenMPI"
      - name: HDF5
        action: ExecuteBash
        inputs:
          commands:
            - |-
              #!/bin/bash
              set -x
              echo "Start openbraininstitute step: HDF5"
              export HOME=/root
              export PATH=/opt/amazon/openmpi5/bin:${PATH}
              export LD_LIBRARY_PATH=/opt/amazon/openmpi5/lib64:${LD_LIBRARY_PATH}
              set -euo pipefail
              export CC=$(which mpicc)
              export CXX=$(which mpic++)
              mkdir hdf5
              cd hdf5
              curl -O https://support.hdfgroup.org/releases/hdf5/v1_14/v1_14_6/downloads/hdf5-1.14.6.tar.gz
              tar xf hdf5-1.14.6.tar.gz
              cd hdf5-1.14.6
              set +e
              ./configure --enable-parallel --enable-shared --prefix=/opt/circuit_simulation/hdf5/hdf5-1.14.6/install
              if [ $? -ne 0 ]; then cat config.log; exit 1; fi
              set -e
              make -j
              make install
              cd ..
              rm -rf hdf5*
              echo "End openbraininstitute step: HDF5"
      - name: neurodamus_venv
        action: ExecuteBash
        inputs:
          commands:
            - |-
              #!/bin/bash
              set -x
              echo "Start openbraininstitute step: neurodamus_venv"
              export HOME=/root
              export PATH=/opt/amazon/openmpi5/bin:${PATH}
              export LD_LIBRARY_PATH=/opt/amazon/openmpi5/lib64:${LD_LIBRARY_PATH}
              export PATH=/opt/circuit_simulation/hdf5/hdf5-1.14.6/install/bin:$PATH
              export LD_LIBRARY_PATH=/opt/circuit_simulation/hdf5/hdf5-1.14.6/install/lib:$LD_LIBRARY_PATH
              set -euo pipefail
              python3.11 -m venv neurodamus_venv
              source neurodamus_venv/bin/activate
              pip install --upgrade pip
              pip install --upgrade setuptools
              pip install --upgrade cython jinja2 numpy pkgconfig pytest pyyaml sympy wheel
              echo "End openbraininstitute step: neurodamus_venv"
